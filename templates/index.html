<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Music Gen Webui 2.0</title>

<link rel="stylesheet" href="{{ url_for('static', filename='main-style.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

</head>

<body>
    {% macro slider_field(id, name, min_value, max_value, step_value, data) %}
    <div class="field param-field" data-param="{{ id }}">
        <label for="{{ id }}">{{ name }} <span class="info-icon" data-target="{{ id }}" title="参数说明">ℹ</span></label>
        <input type="range" id="{{ id }}" name="{{ name }}" min="{{ min_value }}" max="{{ max_value }}" step="{{ step_value }}" value="{{ data }}" oninput="updateSliderValue('{{ id }}', this.value)">
        <input type="text" id="{{ id }}-text" value="{{ data }}" class="slider-value" oninput="updateRangeValue('{{ id }}', this.value)">
    </div>
    <script>
        function updateSliderValue(sliderName, value) {
            document.getElementById(sliderName + '-text').value = value;
            socket.emit('slider_change', {sliderName: sliderName, value: value});
        }

        function updateRangeValue(sliderName, value) {
            var rangeInput = document.getElementById(sliderName);
            var newValue = parseFloat(value);
            if (!isNaN(newValue) && newValue >= parseFloat(rangeInput.min) && newValue <= parseFloat(rangeInput.max)) {
                rangeInput.value = newValue;
                socket.emit('slider_change', {sliderName: sliderName, value: newValue});
            }
        }
    </script>
    {% endmacro %}
    <div class="container"></div>
        <!-- 状态栏 -->
        <div class="status-bar" id="status-bar">
            <div class="status-fill" id="status-fill" style="width:0%"></div>
            <div class="status-text" id="status-text">就绪</div>
        </div>
        <div class="third-box">

            <div class="mode-switch">
                <button id="mode-text" class="mode-button active">纯文本</button>
                <button id="mode-melody" class="mode-button">Melody</button>
            </div>

            <div id="text-mode-panel" class="mode-panel">
                <label class="panel-title">选择模型</label>
                <select id="modelSelector" class="model-selector">
                    {% set text_model_options = ["small", "medium", "large"] %}
                    {% for option in text_model_options %}
                        <option value="{{ option }}" {% if option == default_model %}selected{% endif %}>{{ option.capitalize() }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="melody-mode-panel" class="mode-panel" style="display:none">
                <label class="panel-title">上传参考旋律</label>
                <div id="melody-field" class="field">
                    <div class="upload-row">
                        <input type="file" id="melody" name="melody" accept="audio/*">
                        <span id="melody-check" class="check-icon" title="上传完成" aria-label="上传完成" style="display:none">✓</span>
                    </div>
                    <audio id="audio-preview" controls></audio>
                    <div class="hint">仅支持音频文件，提交前需先上传。<span id="melody-upload-status" class="upload-status">未上传</span></div>
                </div>
            </div>

            <div class="group slider-group">
                <div>
                    {{ slider_field('top_k', 'Top K', 0, 1000, 1, topk) }}
                    {{ slider_field('duration', 'Duration', 1, 1000, 1, duration) }}
                    {{ slider_field('cfg_coef', 'CFG', 1, 10, 0.1, cfg_coef) }}
                </div>

                <div>
                    {{ slider_field('top_p', 'Top-Probability', 0, 1, 0.01, topp) }}
                    {{ slider_field('temperature', 'Temperature', 0.1, 5, 0.01, temperature) }}
                </div>
            </div>

            <div class="advanced-panel">
                <div class="panel-title">高级设置</div>
                <div class="advanced-group">
                    <div class="field param-field" data-param="two_step_cfg">
                        <label for="two_step_cfg">Two-step CFG <span class="info-icon" title="参数说明">ℹ</span></label>
                        <input type="checkbox" id="two_step_cfg" />
                    </div>

                    <div class="field param-field" data-param="seed">
                        <label for="seed">固定种子 <span class="info-icon" title="参数说明">ℹ</span></label>
                        <div class="seed-row">
                            <input type="checkbox" id="seed-fixed" checked/>
                            <input type="number" id="seed" placeholder="如 12345" class="seed-input" value="{{ default_seed }}" />
                        </div>
                    </div>

                    {{ slider_field('loudness_headroom_db', 'Loudness Headroom (dB)', 10, 24, 1, 18) }}
                    {{ slider_field('fade_ms', 'Fade In/Out (ms)', 0, 400, 10, 60) }}
                    <div class="field param-field" data-param="resample_44k">
                        <label for="resample_44k">重采样到 44.1kHz <span class="info-icon" title="参数说明">ℹ</span></label>
                        <input type="checkbox" id="resample_44k" />
                    </div>
                </div>
            </div>

            <div class="submit-container">
                <textarea id="text" name="text" rows="3" required="">{{ default_text }}</textarea>
                <button type="button" class="submit-button" onclick="submitSliders()">Submit</button>
            </div>
        </div>

        <div class="prompt-queue third-box"></div>
        <div class="audio-list third-box"></div>   
    </div>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
